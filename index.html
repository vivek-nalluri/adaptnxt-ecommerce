<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple E-Commerce</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<header><h1>Simple E-Commerce</h1></header>

<div class="container">
    <div id="authSection" class="box">
        <div id="registerBox">
            <h2>Register</h2>
            <input id="rname" placeholder="Name">
            <input id="remail" placeholder="Email">
            <input id="rpass" type="password" placeholder="Password">
            <select id="rrole">
                <option value="customer">Customer</option>
                <option value="admin">Admin</option>
            </select>
            <button onclick="register()">Register</button>
            <p>Already have an account? <a onclick="toggleAuth()" style="cursor:pointer; color:#2563eb;">Login</a></p>
        </div>
        <div id="loginBox" style="display:none;">
            <h2>Login</h2>
            <input id="lemail" placeholder="Email">
            <input id="lpass" type="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <p>Don't have an account? <a onclick="toggleAuth()" style="cursor:pointer; color:#2563eb;">Register</a></p>
        </div>
    </div>

    <div id="productSection" class="box" style="display:none;">
        <h2>Products</h2>
        <input id="searchBox" placeholder="Search products..." onkeyup="loadProducts(1)">
        <div id="productList"></div>
        <div class="pagination">
            <button onclick="changePage(-1)">Prev</button>
            <span id="pageNum">1</span>
            <button onclick="changePage(1)">Next</button>
        </div>
    </div>

    <div id="cartSection" class="box" style="display:none;">
        <h2>Cart</h2>
        <div id="cartItems"></div>
        <div id="cartBill" class="bill-summary"></div>
        <button onclick="placeOrder()">Place Order</button>
    </div>

    <div id="adminPanel" class="box" style="display:none;">
        <h2>Admin Panel</h2>
        <input id="pname" placeholder="Product name">
        <input id="pcat" placeholder="Category">
        <input id="pprice" type="number" placeholder="Price">
        <input id="pstock" type="number" placeholder="Stock">
        <button onclick="addProduct()">Add Product</button>
    </div>

    <div class="footer" id="logoutFooter" style="display:none;">
        <button onclick="logout()">Logout</button>
    </div>
</div>

<script>
let token = '', userRole = '', currentPage = 1, lastPage = false;

// Dynamically determine the API endpoint
const api = 'https://adaptnxt-ecommerce-iq9l.onrender.com/api';
function toggleAuth() {
    const reg = document.getElementById('registerBox');
    const log = document.getElementById('loginBox');
    reg.style.display = reg.style.display === 'none' ? 'block' : 'none';
    log.style.display = log.style.display === 'none' ? 'block' : 'none';
}

function register() {
    fetch(api + '/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: rname.value,
            email: remail.value,
            password: rpass.value,
            role: rrole.value
        })
    }).then(res => res.json()).then(data => alert(data.message || 'Registered'));
}

function login() {
    const email = document.getElementById('lemail').value;
    const password = document.getElementById('lpass').value;

    // Basic client-side validation
    if (!email || !password) {
        alert('Please enter both email and password.');
        return;
    }

    fetch(api + '/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
    })
    .then(res => {
        // Check for non-2xx HTTP status codes
        if (!res.ok) {
            return res.json().then(errorData => {
                throw new Error(errorData.message || 'Login failed.');
            });
        }
        return res.json();
    })
    .then(data => {
        token = data.token;
        userRole = data.user.role;
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('productSection').style.display = 'block';
        document.getElementById('cartSection').style.display = userRole === 'customer' ? 'block' : 'none';
        document.getElementById('adminPanel').style.display = userRole === 'admin' ? 'block' : 'none';
        document.getElementById('logoutFooter').style.display = 'block';
        loadProducts(1);
        if (userRole === 'customer') loadCart();
        alert('Login successful!'); // More specific success message
    })
    .catch(error => {
        // Catch any network or server-side errors
        alert(error.message);
        console.error('Error:', error);
    });
}

function logout() {
    token = '';
    location.reload();
}

function changePage(delta) {
    if (delta === 1 && lastPage) return;
    currentPage += delta;
    if (currentPage < 1) currentPage = 1;
    document.getElementById('pageNum').innerText = currentPage;
    loadProducts(currentPage);
}

function loadProducts(page = 1) {
    const search = document.getElementById('searchBox').value;
    // Change the limit from 5 to 6 here
    fetch(`${api}/products?search=${search}&page=${page}&limit=6`) 
        .then(res => res.json())
        .then(data => {
            // Update the lastPage logic to check for a length less than 6
            lastPage = data.length < 6; 
            document.getElementById('productList').innerHTML = data.map(p => `
                <div class="product">
                    <span>${p.name} - $${p.price}</span>
                    <div class="product-actions">
                        ${userRole === 'customer' ? `<button onclick="addToCart('${p._id}')">Add</button>` : ''}
                        ${userRole === 'admin' ? `
                            <button onclick="deleteProduct('${p._id}')">Delete</button>
                            <button onclick="updateProductPrompt('${p._id}', '${p.name}', '${p.category}', ${p.price}, ${p.stock})">Edit</button>` : ''}
                    </div>
                </div>`).join('');
        });
}

function addToCart(pid) {
    fetch(`${api}/cart`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({ productId: pid, quantity: 1 })
    }).then(() => loadCart());
}

function loadCart() {
    fetch(`${api}/cart`, {
        headers: { Authorization: 'Bearer ' + token }
    }).then(res => res.json()).then(cart => {
        let total = 0;
        document.getElementById('cartItems').innerHTML = cart.items.map(i => {
            total += i.quantity * i.productId.price;
            return `
            <div class="cart-item">
                <span>${i.productId.name} ($${i.productId.price})</span>
                <div class="cart-actions">
                    <button class="qty-btn" onclick="updateQty('${i.productId._id}', ${i.quantity - 1})">-</button>
                    <span>${i.quantity}</span>
                    <button class="qty-btn" onclick="updateQty('${i.productId._id}', ${i.quantity + 1})">+</button>
                    <button onclick="removeItem('${i.productId._id}')">Remove</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('cartBill').innerText = 'Total: $' + total.toFixed(2);
    });
}

function updateQty(pid, qty) {
    if (qty < 1) return;
    fetch(`${api}/cart`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({ productId: pid, quantity: qty })
    }).then(() => loadCart());
}

function removeItem(pid) {
    fetch(`${api}/cart/${pid}`, {
        method: 'DELETE',
        headers: { Authorization: 'Bearer ' + token }
    }).then(() => loadCart());
}

function placeOrder() {
    fetch(`${api}/orders`, {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token }
    }).then(res => res.json()).then(data => {
        alert('Order placed successfully! Invoice generated below.');
        loadCart();
    });
}

function addProduct() {
    fetch(`${api}/products`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({
            name: pname.value,
            category: pcat.value,
            price: parseFloat(pprice.value),
            stock: parseInt(pstock.value)
        })
    }).then(res => res.json()).then(data => {
        if (data.message && data.message.includes("already exists")) {
            alert(data.message);
        } else {
            alert("Product added successfully!");
            loadProducts(1);
        }
    });
}
function deleteProduct(id) {
    fetch(`${api}/products/${id}`, {
        method: 'DELETE',
        headers: { Authorization: 'Bearer ' + token }
    }).then(() => loadProducts(currentPage));
}

function updateProductPrompt(id, name, category, price, stock) {
    const newName = prompt("Update name:", name);
    const newCat = prompt("Update category:", category);
    const newPrice = prompt("Update price:", price);
    const newStock = prompt("Update stock:", stock);
    fetch(`${api}/products/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({ name: newName, category: newCat, price: parseFloat(newPrice), stock: parseInt(newStock) })
    }).then(() => loadProducts(currentPage));
}
</script>

</body>
</html>
